# 文件预览和下载功能优化说明

## 优化概述

本次对文件预览和下载功能进行了全面升级，主要实现了以下目标：
1. **文件下载使用原始文件名**
2. **支持文件内容预览**
3. **支持压缩文件内容预览**

## 功能特点

### 1. 原始文件名下载
- **问题解决**：之前下载的文件使用UUID命名，用户无法识别
- **新功能**：下载时自动使用原始上传的文件名
- **技术实现**：在文件上传时保存原始文件名，下载时通过API参数传递

### 2. 文件内容预览
- **文本文件**：支持直接预览文件内容（最多100行）
- **代码文件**：支持语法高亮预览（.js, .ts, .vue, .jsx, .tsx, .py, .java, .cpp, .c等）
- **配置文件**：支持JSON、XML、HTML、CSS等格式预览
- **文档文件**：支持Markdown、TXT等文件预览

### 3. 压缩文件预览
- **ZIP文件**：显示压缩包内所有文件和文件夹列表
- **文件信息**：显示文件名、大小、类型、修改时间
- **目录结构**：清晰展示压缩包的目录结构
- **RAR支持**：提示暂不支持，但可以下载

### 4. 增强的用户界面
- **预览对话框**：80%宽度的大型对话框，提供更好的预览体验
- **加载状态**：显示文件加载进度
- **错误处理**：友好的错误提示和降级方案
- **响应式设计**：适配不同屏幕大小

## 技术实现

### 后端实现

#### 1. 文件上传改进 (`ChatController.java`)
```java
@PostMapping("/upload-file")
public Result<Map<String, Object>> uploadChatFile(
        @RequestParam("file") MultipartFile file,
        @RequestParam("userId") Long userId) {
    // ... 上传逻辑 ...
    
    Map<String, Object> result = new HashMap<>();
    result.put("fileUrl", fileUrl);
    result.put("fileName", file.getOriginalFilename());
    result.put("originalFileName", file.getOriginalFilename()); // 新增
    result.put("storagePath", storagePath); // 新增
    // ...
}
```

#### 2. 文件下载接口 (`ChatController.java`)
```java
@GetMapping("/download-file")
public ResponseEntity<Resource> downloadFile(
        @RequestParam("fileUrl") String fileUrl,
        @RequestParam("originalFileName") String originalFileName) {
    // 使用原始文件名下载
    return ResponseEntity.ok()
            .header(HttpHeaders.CONTENT_DISPOSITION, 
                   "attachment; filename=\"" + URLEncoder.encode(originalFileName, StandardCharsets.UTF_8) + "\"")
            .body(resource);
}
```

#### 3. 文件预览接口 (`ChatController.java`)
```java
@GetMapping("/preview-file")
public Result<Map<String, Object>> previewFile(
        @RequestParam("fileUrl") String fileUrl,
        @RequestParam("fileType") String fileType) {
    Map<String, Object> result = fileUploadService.previewFile(fileUrl, fileType);
    return Result.success(result);
}
```

#### 4. 文件预览服务 (`FileUploadServiceImpl.java`)
- **文本文件预览**：读取前100行内容
- **ZIP文件预览**：解析压缩包结构，提取文件列表
- **文件流管理**：安全的文件流获取和关闭

### 前端实现

#### 1. API接口扩展 (`chat.js`)
```javascript
// 下载文件（使用原始文件名）
export const downloadChatFile = (fileUrl, originalFileName) => {
  return api.get('/chat/download-file', {
    params: { fileUrl, originalFileName },
    responseType: 'blob'
  })
}

// 预览文件内容
export const previewChatFile = (fileUrl, fileType) => {
  return api.get('/chat/preview-file', {
    params: { fileUrl, fileType }
  })
}
```

#### 2. 文件预览组件优化 (`FilePreview.vue`)
- **原始文件名显示**：优先使用 `originalFileName`
- **内容预览**：异步加载文件内容
- **ZIP文件表格**：使用 Element Plus 表格组件展示
- **加载状态**：显示加载动画和进度

## 支持的预览格式

### 文本文件
| 格式 | 扩展名 | 预览内容 |
|------|--------|----------|
| 纯文本 | .txt | 文件完整内容（前100行） |
| Markdown | .md | 原始Markdown语法 |
| JSON | .json | 格式化的JSON数据 |
| XML | .xml | XML标记内容 |
| HTML | .html | HTML源码 |
| CSS | .css | 样式表代码 |
| JavaScript | .js, .ts | 代码内容 |
| Vue组件 | .vue | 组件源码 |
| React组件 | .jsx, .tsx | 组件源码 |
| Python | .py | Python代码 |
| Java | .java | Java源码 |
| C/C++ | .c, .cpp | C/C++代码 |

### 压缩文件
| 格式 | 支持状态 | 预览内容 |
|------|----------|----------|
| ZIP | ✅ 完全支持 | 文件列表、大小、修改时间 |
| RAR | ⚠️ 部分支持 | 提示下载后查看 |
| 7Z | ❌ 暂不支持 | 提示下载后查看 |
| TAR.GZ | ❌ 暂不支持 | 提示下载后查看 |

## 使用说明

### 1. 文件上传
1. 在聊天界面选择文件上传
2. 系统自动保存原始文件名和存储路径的映射关系
3. 聊天中显示文件卡片

### 2. 文件预览
1. **点击文件图标或文件名**：打开预览对话框
2. **文本文件**：直接显示文件内容，支持代码语法
3. **ZIP文件**：显示压缩包内文件列表和详细信息
4. **其他文件**：显示基本信息和操作按钮

### 3. 文件下载
1. **点击下载按钮**：直接下载到本地
2. **使用原始文件名**：下载的文件保持原始上传时的名称
3. **浏览器兼容**：支持所有现代浏览器的下载功能

## 预览界面说明

### 文本文件预览
```
┌─────────────────────────────────────────┐
│ 文件内容预览：                            │
│ ┌─────────────────────────────────────┐ │
│ │ function example() {                 │ │
│ │   console.log("Hello World");       │ │
│ │   return true;                      │ │
│ │ }                                   │ │
│ └─────────────────────────────────────┘ │
│ ⚠️ 仅显示前100行内容，完整内容请下载查看    │
└─────────────────────────────────────────┘
```

### ZIP文件预览
```
┌─────────────────────────────────────────┐
│ 压缩包内容：                              │
│ ┌─────────────────────────────────────┐ │
│ │ 文件名    │ 大小  │ 类型 │ 修改时间    │ │
│ │ src/      │ -     │ 文件夹│ 2024-01-01 │ │
│ │ README.md │ 1.2KB │ 文件 │ 2024-01-01 │ │
│ │ index.js  │ 856B  │ 文件 │ 2024-01-01 │ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

## 性能优化

### 1. 文件大小限制
- **文本预览**：最多读取100行，避免内存溢出
- **ZIP预览**：最多显示50个条目，加快加载速度
- **文件大小**：预览前检查文件大小，超大文件直接提示下载

### 2. 内存管理
- **流式处理**：使用流式读取，减少内存占用
- **自动关闭**：确保文件流正确关闭，避免资源泄露
- **错误处理**：完善的异常处理机制

### 3. 用户体验
- **异步加载**：文件预览异步加载，不阻塞界面
- **加载动画**：显示加载状态，改善用户体验
- **错误降级**：预览失败时提供下载选项

## 安全考虑

### 1. 文件类型验证
- **服务端验证**：严格验证文件类型和大小
- **安全扫描**：防止恶意文件上传
- **访问控制**：确保只有授权用户可以访问文件

### 2. 路径安全
- **路径遍历防护**：防止 `../` 等路径遍历攻击
- **文件名过滤**：过滤特殊字符，确保文件名安全
- **权限检查**：下载前验证用户权限

## 更新日志

### v2.0 (当前版本)
- ✅ 实现原始文件名下载
- ✅ 添加文本文件内容预览
- ✅ 添加ZIP压缩包内容预览
- ✅ 优化预览界面UI/UX
- ✅ 增强错误处理和用户反馈
- ✅ 提升文件处理性能

### 未来计划
- 🔄 支持更多压缩格式（7Z, TAR.GZ）
- 🔄 添加图片文件在线编辑功能
- 🔄 支持Office文档在线预览
- 🔄 实现文件版本管理
- 🔄 添加文件分享链接功能

## 开发者说明

### 添加新的预览格式
1. 在 `FileUploadServiceImpl.java` 中添加新的预览方法
2. 在 `previewFile()` 方法中添加格式判断逻辑
3. 在前端 `FilePreview.vue` 中添加对应的预览组件

### 自定义下载逻辑
可以通过修改 `downloadFile()` 方法来自定义下载行为，例如添加下载日志、权限检查等。

### 扩展文件类型支持
在 `getFileIcon()` 和 `getFileTypeDescription()` 方法中添加新的文件类型判断逻辑。 